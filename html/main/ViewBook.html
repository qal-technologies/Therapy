<!DOCTYPE html><html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Book Viewer â€“ Drag Flip</title>
  <style>
    :root{
      --bg:#1f1b1a;--panel:#23201f;--paper:#f1e7cf;--ink:#1a1a1a;--muted:#9e9587;--shadow:rgba(0,0,0,.35);
      --footer-h:64px; --toolbar-h:56px; --zoom:1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:#eee;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;position:relative;overflow:hidden;display:grid;grid-template-rows:var(--toolbar-h) 1fr}/* TOP BAR */
header{
  display:flex;align-items:center;gap:10px;padding:8px 12px;background:linear-gradient(180deg,#2b2826,#211f1e);border-bottom:1px solid #3a3835
}
.brand{font-weight:600;opacity:.9;white-space:nowrap}
.search-wrap{flex:1}
.search{width:100%;height:38px;border-radius:10px;border:1px solid #3b3936;background:#1e1d1b;color:#eee;padding:0 12px 0 38px;outline:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23a8a29e"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5L20.49 19l-5-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>');background-repeat:no-repeat;background-position:10px 50%;background-size:18px}
.tools{display:flex;gap:8px}
.btn{display:inline-grid;place-items:center;min-width:38px;height:38px;padding:0 10px;border-radius:10px;border:1px solid #3b3936;background:#1e1d1b;color:#e8e6e3;cursor:pointer}
.btn:hover{background:#232220}

/* STAGE / BOOK */
main{position:relative;overflow:hidden;display:grid;place-items:center;padding:8px;}
.stage{position:relative;width:100%;height:100%;display:grid;place-items:center;}
.book{position:relative;transform:scale(var(--zoom));transform-origin:center;perspective:2000px;width:min(92vw,1200px);height:min(74vh,840px);}

/* base layers */
.sheet{position:absolute;top:0;bottom:0;width:50%;background:var(--paper);color:var(--ink);box-shadow:0 6px 20px rgba(0,0,0,.28);overflow:hidden;}
.sheet.left{left:0;border-top-right-radius:8px;border-bottom-right-radius:8px}
.sheet.right{right:0;border-top-left-radius:8px;border-bottom-left-radius:8px}
.content{position:absolute;inset:0;display:grid;place-items:center;padding:8%;font-size:clamp(14px,1.5vw,18px);line-height:1.6}

/* under-sheets for reveal */
.under{position:absolute;top:0;bottom:0;width:50%;background:var(--paper);color:var(--ink);box-shadow:inset 0 0 0 1px rgba(0,0,0,.05)}
.under.right{right:0;border-top-left-radius:8px;border-bottom-left-radius:8px}
.under.left{left:0;border-top-right-radius:8px;border-bottom-right-radius:8px}

/* flipping page overlay */
.flip{position:absolute;top:0;bottom:0;width:50%;overflow:hidden;transform-style:preserve-3d;}
.flip.right{right:0;transform-origin:right center}
.flip.left{left:0;transform-origin:left center}
.face{position:absolute;inset:0;backface-visibility:hidden;background:var(--paper);}
.face .content{padding:8%}
.back{transform:rotateY(180deg)}

.shade{position:absolute;inset:0;pointer-events:none;background:linear-gradient(90deg, rgba(0,0,0,.25), rgba(0,0,0,0));mix-blend-mode:multiply;opacity:.5}
.flip.left .shade{background:linear-gradient(270deg, rgba(0,0,0,.25), rgba(0,0,0,0))}

/* Book edges */
.edges{position:absolute;top:8px;bottom:8px;width:16px;background:repeating-linear-gradient(to bottom,#d6ccb7,#d6ccb7 3px,#ece2cd 3px,#ece2cd 6px);box-shadow:inset 0 0 10px rgba(0,0,0,.18)}
.edges.left{left:-16px}
.edges.right{right:-16px}

/* MOBILE: single-page */
.single .sheet{width:100%;right:auto;left:0;border-radius:8px}
.single .under{width:100%}
.single .edges.left{display:none}

/* BOTTOM TOOLBAR (absolute) */
footer{position:absolute;left:0;right:0;bottom:0;height:var(--footer-h);display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px;background:linear-gradient(180deg,#232220,#1c1b19);border-top:1px solid #3a3835;padding:8px 12px;z-index:50}
.bottom-left,.bottom-right{display:flex;gap:8px}
.pager{display:flex;gap:12px;align-items:center;justify-content:center}
.page-info{min-width:120px;text-align:center;opacity:.9;font-variant-numeric:tabular-nums}

@media (max-width: 900px){
  .book{width:min(96vw,720px);height:min(76vh,760px)}
}
@media (max-width: 700px){
  header .tools .label{display:none}
}

  </style>
</head>
<body>
  <!-- TOP BAR -->
  <header>
    <div class="brand" id="bookTitle">Compagnon FÃ©minin</div>
    <div class="search-wrap"><input id="search" class="search" type="search" placeholder="Search chapter or page â€“ Compagnon FÃ©minin"></div>
    <div class="tools">
      <button class="btn" id="soundToggle" title="Toggle flip sound">ðŸ”Š <span class="label">Sound</span></button>
      <button class="btn" id="fullscreen" title="Fullscreen">â›¶</button>
    </div>
  </header>  <!-- STAGE / BOOK -->  <main>
    <div class="stage">
      <div class="book" id="book">
        <div class="edges left"></div>
        <div class="edges right"></div>
        <div class="under left" id="underLeft"><div class="content"></div></div>
        <div class="under right" id="underRight"><div class="content"></div></div>
        <div class="sheet left" id="leftPage"><div class="content"></div></div>
        <div class="sheet right" id="rightPage"><div class="content"></div></div>
      </div><!-- BOTTOM TOOLBAR -->
  <footer>
    <div class="bottom-left">
      <button class="btn" id="bookmarkBtn" title="Bookmark this page">ðŸ”–</button>
    </div>
    <div class="pager">
      <button class="btn" id="prevBtn" title="Previous">â—€</button>
      <div class="page-info" id="pageInfo">1/1</div>
      <button class="btn" id="nextBtn" title="Next">â–¶</button>
    </div>
    <div class="bottom-right">
      <button class="btn" id="zoomOut" title="Zoom out">âˆ’</button>
      <button class="btn" id="zoomIn" title="Zoom in">ï¼‹</button>
    </div>
  </footer>
</div>

  </main>  <!-- SOUND -->  <audio id="flipAudio">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQAA" type="audio/mpeg">
  </audio>  <script>
    // ===== Book Data (p tags only) =====
    const BOOK = {
      title: 'Compagnon FÃ©minin',
      pages: Array.from({length: 24}, (_,i) => `This is Page ${i+1}`),
      chapters: [ {title:'Introduction â€” You Are Alone', page:1}, {title:'Part I', page:5}, {title:'Part II', page:13} ]
    };

    // ===== State =====
    const state = { page: 1, // logical left page on spread; current page on single
                    spread: false, soundOn: true, zoom: 1 };

    // ===== Elements =====
    const bookEl = document.getElementById('book');
    const leftSheet = document.getElementById('leftPage').querySelector('.content');
    const rightSheet = document.getElementById('rightPage').querySelector('.content');
    const underLeft = document.getElementById('underLeft').querySelector('.content');
    const underRight = document.getElementById('underRight').querySelector('.content');
    const pageInfo = document.getElementById('pageInfo');
    const audioEl = document.getElementById('flipAudio');

    const qs = (s,r=document)=>r.querySelector(s); const qsa = (s,r=document)=>[...r.querySelectorAll(s)];

    // ===== Responsive =====
    const mq = window.matchMedia('(min-width: 900px)');
    function applyLayout(){
      state.spread = mq.matches; // true => two pages visible
      bookEl.classList.toggle('single', !state.spread);

      // edges visibility
      qs('.edges.left').style.display = state.spread ? 'block' : 'none';
      qs('.edges.right').style.display = 'block';

      if(state.spread && state.page % 2 === 0) state.page -= 1; // left page must be odd
      render();
    }
    mq.addEventListener('change', applyLayout);

    // ===== Render =====
    function render(){
      document.getElementById('bookTitle').textContent = BOOK.title;
      document.getElementById('search').placeholder = `Search chapter or page â€“ ${BOOK.title}`;

      const total = BOOK.pages.length;
      let p = clamp(state.page,1,total);
      if(state.spread && p % 2 === 0) p -= 1; // keep odd on spread
      state.page = p;

      leftSheet.textContent = state.spread ? textFor(p) : textFor(p);
      rightSheet.textContent = state.spread ? textFor(p+1) : '';
      underLeft.textContent = state.spread ? textFor(p-1) : '';
      underRight.textContent = state.spread ? textFor(p+2) : textFor(p+1);

      // page indicator = current page / total (on spread -> right page index)
      const currentDisplay = state.spread ? clamp(p+1,1,total) : p;
      pageInfo.textContent = `${currentDisplay}/${total}`;

      // bookmark pressed state
      const bm = loadBookmark();
      qs('#bookmarkBtn').setAttribute('aria-pressed', bm === currentDisplay);
    }
    function textFor(idx){
      const t = BOOK.pages[idx-1];
      return t ? t : '';
    }
    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

    // ===== Zoom =====
    function zoom(delta){ state.zoom = clamp(Number((state.zoom + delta).toFixed(2)), .7, 2); document.documentElement.style.setProperty('--zoom', state.zoom); }
    qs('#zoomIn').addEventListener('click', ()=>zoom(.1));
    qs('#zoomOut').addEventListener('click', ()=>zoom(-.1));

    // ===== Sound =====
    function toggleSound(){ state.soundOn = !state.soundOn; qs('#soundToggle').textContent = state.soundOn ? 'ðŸ”Š' : 'ðŸ”ˆ'; }
    qs('#soundToggle').addEventListener('click', toggleSound);

    // ===== Bookmark =====
    function saveBookmark(){ const pg = state.spread ? clamp(state.page+1,1,BOOK.pages.length) : state.page; localStorage.setItem('bookmarkPage', String(pg)); qs('#bookmarkBtn').setAttribute('aria-pressed','true'); }
    function loadBookmark(){ const p=parseInt(localStorage.getItem('bookmarkPage')||''); return Number.isFinite(p)?clamp(p,1,BOOK.pages.length):null; }
    qs('#bookmarkBtn').addEventListener('click', saveBookmark);

    // ===== Fullscreen =====
    qs('#fullscreen').addEventListener('click', ()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else document.exitFullscreen(); });

    // ===== Search (by chapter title or page number) =====
    qs('#search').addEventListener('keydown', (e)=>{ if(e.key!=='Enter') return; const q=e.target.value.trim(); if(!q) return; const n=parseInt(q,10); if(Number.isFinite(n)){ goTo(n); return;} const m=BOOK.chapters.find(ch=>ch.title.toLowerCase().includes(q.toLowerCase())); if(m) goTo(m.page); });
    function goTo(num){ const total=BOOK.pages.length; num=clamp(num,1,total); if(state.spread && num%2===0) num-=1; state.page=num; render(); saveReadingPosition(); }

    // ===== Persist last read =====
    function saveReadingPosition(){ localStorage.setItem('lastReadPage', String(state.page)); }
    function loadReadingPosition(){ const p=parseInt(localStorage.getItem('lastReadPage')||''); return Number.isFinite(p)?clamp(p,1,BOOK.pages.length):1; }

    // ===== Flip helpers =====
    function playFlip(){ if(state.soundOn){ try{ audioEl.currentTime=0; audioEl.play(); }catch(_){} } }

    function createFlipOverlay(direction){ // 'forward' uses right, 'back' uses left
      const flip = document.createElement('div'); flip.className = 'flip ' + (direction==='forward' ? 'right' : 'left');
      const front = document.createElement('div'); front.className='face front';
      const back  = document.createElement('div'); back.className='face back';
      const shade = document.createElement('div'); shade.className='shade';

      const total = BOOK.pages.length; const p = state.page;
      if(direction==='forward'){
        // right page turns to left: front = p+1, back = p+2
        front.innerHTML = `<div class="content">${textFor(p+1)}</div>`;
        back.innerHTML  = `<div class="content">${textFor(p+2)}</div>`;
        qs('#underRight').querySelector('.content').textContent = textFor(p+2);
      } else {
        // left page turns back to right: front = p, back = p-1
        front.innerHTML = `<div class="content">${textFor(p)}</div>`;
        back.innerHTML  = `<div class="content">${textFor(p-1)}</div>`;
        qs('#underLeft').querySelector('.content').textContent = textFor(p-1);
      }
      flip.append(front, back, shade);
      bookEl.appendChild(flip);
      return flip;
    }

    // programmatic flip (no drag)
    function flipForward(){ const total=BOOK.pages.length; if((state.spread && state.page+1>=total) || (!state.spread && state.page>=total)) return; const flip=createFlipOverlay('forward');
      // animate
      flip.style.transition='transform .6s ease'; flip.style.transform='rotateY(-180deg)';
      playFlip();
      flip.addEventListener('transitionend', ()=>{ flip.remove(); advanceIndex('forward'); render(); saveReadingPosition(); }, {once:true}); }

    function flipBack(){ if((state.spread && state.page<=1) || (!state.spread && state.page<=1)) return; const flip=createFlipOverlay('back');
      flip.style.transform='rotateY(180deg)'; // start as closed
      // force reflow then animate to 0
      getComputedStyle(flip).transform; flip.style.transition='transform .6s ease'; flip.style.transform='rotateY(0deg)';
      playFlip();
      flip.addEventListener('transitionend', ()=>{ flip.remove(); advanceIndex('back'); render(); saveReadingPosition(); }, {once:true}); }

    function advanceIndex(dir){ if(state.spread){ state.page += (dir==='forward'?2:-2); if(state.page<1) state.page=1; } else { state.page += (dir==='forward'?1:-1); state.page = clamp(state.page,1,BOOK.pages.length); } }

    // Buttons
    qs('#nextBtn').addEventListener('click', flipForward);
    qs('#prevBtn').addEventListener('click', flipBack);

    // ===== Drag-follow + Swipe =====
    let drag = { active:false, dir:null, startX:0, width:0, flipEl:null };

    function dragStart(e){
      const isTouch = e.type.startsWith('touch');
      const x = isTouch ? e.touches[0].clientX : e.clientX;
      drag.startX = x; drag.active = true; drag.width = bookEl.clientWidth/2;

      if(state.spread){
        // Determine which side user grabbed
        const rect = bookEl.getBoundingClientRect();
        const isRightHalf = x > rect.left + rect.width/2;
        drag.dir = isRightHalf ? 'forward' : 'back';
      } else {
        // single page: swipe left -> forward; we always treat as right page turning
        drag.dir = 'forward';
      }

      drag.flipEl = createFlipOverlay(drag.dir);
      if(drag.dir==='back'){ drag.flipEl.style.transform='rotateY(180deg)'; }
      drag.flipEl.style.transition='none';
    }

    function dragMove(e){ if(!drag.active) return; const isTouch = e.type.startsWith('touch'); const x = isTouch ? e.touches[0].clientX : e.clientX; let dx = x - drag.startX; let deg = 0;
      if(drag.dir==='forward'){
        // move left -> negative; map to 0..-180
        deg = - clamp((dx<0? -dx : 0) / drag.width * 180, 0, 180);
        drag.flipEl.style.transform = `rotateY(${deg}deg)`; // deg is negative
      } else {
        // back: move right -> positive; map 180..0
        const amt = clamp((dx>0? dx : 0) / drag.width * 180, 0, 180);
        drag.flipEl.style.transform = `rotateY(${180-amt}deg)`; // from 180 down to 0
      }
    }

    function dragEnd(e){ if(!drag.active) return; drag.active=false; const isTouch = e.type.startsWith('touch'); const x = isTouch ? (e.changedTouches? e.changedTouches[0].clientX : e.clientX) : e.clientX; const dx = x - drag.startX; const passed = Math.abs(dx) > 40; // threshold
      // finalize
      if(drag.dir==='forward'){
        if(dx < -40){ // commit forward
          drag.flipEl.style.transition='transform .35s ease';
          drag.flipEl.style.transform='rotateY(-180deg)'; playFlip();
          drag.flipEl.addEventListener('transitionend', ()=>{ drag.flipEl.remove(); advanceIndex('forward'); render(); saveReadingPosition(); }, {once:true});
        } else { // cancel
          drag.flipEl.style.transition='transform .25s ease'; drag.flipEl.style.transform='rotateY(0deg)'; drag.flipEl.addEventListener('transitionend', ()=> drag.flipEl.remove(), {once:true});
        }
      } else { // back
        if(dx > 40){
          drag.flipEl.style.transition='transform .35s ease';
          drag.flipEl.style.transform='rotateY(0deg)'; playFlip();
          drag.flipEl.addEventListener('transitionend', ()=>{ drag.flipEl.remove(); advanceIndex('back'); render(); saveReadingPosition(); }, {once:true});
        } else {
          drag.flipEl.style.transition='transform .25s ease'; drag.flipEl.style.transform='rotateY(180deg)'; drag.flipEl.addEventListener('transitionend', ()=> drag.flipEl.remove(), {once:true});
        }
      }
    }

    // Pointer + touch listeners on book area
    bookEl.addEventListener('mousedown', dragStart);
    window.addEventListener('mousemove', dragMove);
    window.addEventListener('mouseup', dragEnd);
    bookEl.addEventListener('touchstart', dragStart, {passive:true});
    bookEl.addEventListener('touchmove', dragMove, {passive:true});
    bookEl.addEventListener('touchend', dragEnd);

    // ===== Init =====
    (function init(){
      const last = loadReadingPosition(); state.page = last; applyLayout();
    })();
  </script></body>
</html>